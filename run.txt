@echo off
setlocal enabledelayedexpansion

echo MP4 Video Compression Script for Windows
echo =========================================

rem Check if arguments were provided
if "%~1"=="" (
    echo Error: No source directory specified
    echo Usage: %~nx0 "source_directory" "output_directory"
    echo Example: %~nx0 "C:\Videos" "C:\CompressedVideos"
    pause
    exit /b 1
)

if "%~2"=="" (
    echo Error: No output directory specified
    echo Usage: %~nx0 "source_directory" "output_directory"
    echo Example: %~nx0 "C:\Videos" "C:\CompressedVideos"
    pause
    exit /b 1
)

set "SOURCE_DIR=%~1"
set "OUTPUT_DIR=%~2"

echo Source Directory: %SOURCE_DIR%
echo Output Directory: %OUTPUT_DIR%
echo.

rem Check if source directory exists
if not exist "%SOURCE_DIR%" (
    echo Error: Source directory does not exist: %SOURCE_DIR%
    pause
    exit /b 1
)

rem Check if ffmpeg is available
echo Checking for ffmpeg...
ffmpeg -version >nul 2>&1
if errorlevel 1 (
    echo Error: ffmpeg is not installed or not in PATH
    echo Please install ffmpeg from: https://ffmpeg.org/download.html
    echo Or use: winget install ffmpeg
    pause
    exit /b 1
)
echo ffmpeg found!
echo.

rem Create output directory
if not exist "%OUTPUT_DIR%" (
    echo Creating output directory...
    mkdir "%OUTPUT_DIR%"
)

rem Compression settings
set CRF=23
set PRESET=medium

echo Compression settings: CRF=%CRF%, Preset=%PRESET%
echo.

rem Count MP4 files first
echo Scanning for MP4 files...
set count=0
for /r "%SOURCE_DIR%" %%f in (*.mp4) do (
    set /a count+=1
)

if %count%==0 (
    echo No MP4 files found in: %SOURCE_DIR%
    pause
    exit /b 0
)

echo Found %count% MP4 files to process
echo.

rem Process files
set /a processed=0
set /a failed=0

for /r "%SOURCE_DIR%" %%f in (*.mp4) do (
    set /a processed+=1
    
    rem Get relative path
    set "fullpath=%%f"
    set "relpath=!fullpath:%SOURCE_DIR%\=!"
    
    rem Create output path
    set "outfile=%OUTPUT_DIR%\!relpath!"
    
    echo [!processed!/%count%] Processing: !relpath!
    
    rem Create output directory for this file
    for %%d in ("!outfile!") do (
        set "outdir=%%~dpd"
        if not exist "!outdir!" mkdir "!outdir!"
    )
    
    rem Check if output already exists
    if exist "!outfile!" (
        echo   File already exists, skipping...
    ) else (
        rem Compress the video
        echo   Compressing...
        ffmpeg -i "%%f" -c:v libx264 -preset %PRESET% -crf %CRF% -c:a aac -b:a 128k -movflags +faststart -y "!outfile!" -hide_banner -loglevel error
        
        if !errorlevel! equ 0 (
            echo   ✓ Success
        ) else (
            echo   ✗ Failed
            set /a failed+=1
        )
    )
    echo.
)

echo ==========================================
echo Compression Summary:
echo ==========================================
echo Total files: %count%
echo Processed: %processed%
echo Failed: %failed%
set /a success=processed-failed
echo Successful: %success%
echo.
echo Output directory: %OUTPUT_DIR%
echo.
echo Compression complete!
pause
