@echo off
setlocal enabledelayedexpansion

:: MKV to MP4 Conversion and Compression Script
:: Converts and compresses all MKV files to MP4 while maintaining folder structure

echo ================================
echo MKV to MP4 Conversion Script
echo ================================
echo.

:: Check if ffmpeg is available
ffmpeg -version >nul 2>&1
if errorlevel 1 (
    echo ERROR: ffmpeg is not found in PATH
    echo Please install ffmpeg and add it to your system PATH
    echo Download from: https://ffmpeg.org/download.html
    pause
    exit /b 1
)

:: Get source directory
if "%~1"=="" (
    set /p "SOURCE_DIR=Enter source directory path: "
) else (
    set "SOURCE_DIR=%~1"
)

:: Validate source directory
if not exist "!SOURCE_DIR!" (
    echo ERROR: Source directory does not exist: !SOURCE_DIR!
    pause
    exit /b 1
)

:: Get output directory
set /p "OUTPUT_DIR=Enter output directory path: "

:: Create output directory if it doesn't exist
if not exist "!OUTPUT_DIR!" (
    mkdir "!OUTPUT_DIR!"
)

:: Quality settings (you can modify these)
set "CRF=23"
set "PRESET=medium"
set "CODEC=libx264"

echo.
echo Settings:
echo - Source: !SOURCE_DIR!
echo - Output: !OUTPUT_DIR!
echo - Quality (CRF): !CRF! (lower = better quality, larger file)
echo - Preset: !PRESET!
echo - Codec: !CODEC!
echo.
echo DIRECTORY STRUCTURE: The output will mirror the input structure exactly
echo Example: Source\Movies\Action\film.mkv -^> Output\Movies\Action\film.mp4
echo.

:: Confirm before proceeding
set /p "CONFIRM=Continue? (y/n): "
if /i not "!CONFIRM!"=="y" (
    echo Operation cancelled.
    pause
    exit /b 0
)

echo.
echo Starting compression...
echo.

:: Initialize counters
set "TOTAL_FILES=0"
set "PROCESSED_FILES=0"
set "FAILED_FILES=0"

:: Count total MP4 files first
for /r "!SOURCE_DIR!" %%f in (*.mp4) do (
    set /a TOTAL_FILES+=1
)

echo Found !TOTAL_FILES! MKV files to process.
echo.

:: Process all MP4 files
for /r "!SOURCE_DIR!" %%f in (*.mp4) do (
    set "INPUT_FILE=%%f"
    
    :: Get just the drive letter from source directory for proper path calculation
    for /f "tokens=1 delims=:" %%d in ("!SOURCE_DIR!") do set "SOURCE_DRIVE=%%d:"
    
    :: Calculate relative path more robustly
    set "REL_PATH=!INPUT_FILE!"
    
    :: Remove the source directory path from the full path
    call set "REL_PATH=%%REL_PATH:!SOURCE_DIR!=%%"
    
    :: Clean up any leading backslashes
    if "!REL_PATH:~0,1!"=="\" set "REL_PATH=!REL_PATH:~1!"
    
    :: Handle case where paths might be identical (file in root of source)
    if "!REL_PATH!"=="!INPUT_FILE!" (
        for %%n in ("!INPUT_FILE!") do set "REL_PATH=%%~nxn"
    )
    
    :: Create output file path
    set "OUTPUT_FILE=!OUTPUT_DIR!\!REL_PATH!"
    
    :: Create output directory structure (handle long paths)
    for %%d in ("!OUTPUT_FILE!") do (
        set "OUTPUT_DIR_PATH=%%~dpd"
        if not exist "!OUTPUT_DIR_PATH!" (
            mkdir "!OUTPUT_DIR_PATH!" 2>nul
            if !errorlevel! neq 0 (
                echo ERROR: Could not create directory: !OUTPUT_DIR_PATH!
                set /a FAILED_FILES+=1
                goto :continue_loop
            )
        )
    )
    
    :: Skip if output file already exists
    if exist "!OUTPUT_FILE!" (
        echo SKIPPING: !OUTPUT_REL_PATH! (already exists)
        set /a PROCESSED_FILES+=1
    ) else (
        echo Converting: !REL_PATH! -^> !OUTPUT_REL_PATH!
        echo   Input:  !INPUT_FILE!
        echo   Output: !OUTPUT_FILE!
        
        :: Convert and compress MKV to MP4 with high quality settings
        ffmpeg -i "!INPUT_FILE!" ^
               -c:v !CODEC! ^
               -crf !CRF! ^
               -preset !PRESET! ^
               -c:a aac ^
               -b:a 128k ^
               -movflags +faststart ^
               -y "!OUTPUT_FILE!" 2>&1 | findstr /i "error\|failed\|invalid"
        
        :: Check if output file was created successfully
        if exist "!OUTPUT_FILE!" (
            echo SUCCESS: !OUTPUT_REL_PATH!
            set /a PROCESSED_FILES+=1
            
            :: Show file size comparison
            for %%a in ("!INPUT_FILE!") do set "INPUT_SIZE=%%~za"
            for %%b in ("!OUTPUT_FILE!") do set "OUTPUT_SIZE=%%~zb"
            
            if !OUTPUT_SIZE! gtr 0 (
                set /a "COMPRESSION_RATIO=(!INPUT_SIZE! - !OUTPUT_SIZE!) * 100 / !INPUT_SIZE!"
                echo   Original MKV: !INPUT_SIZE! bytes
                echo   Compressed MP4: !OUTPUT_SIZE! bytes
                echo   Saved: !COMPRESSION_RATIO!%%
            )
        ) else (
            echo FAILED: !OUTPUT_REL_PATH! (output file not created)
            set /a FAILED_FILES+=1
        )
    )
    
    :continue_loop
    echo.
)

:: Clean up temporary file
del "!TEMP_LIST!" 2>nul

:: Final summary
echo ================================
echo Compression Complete!
echo ================================
echo Total files found: !TOTAL_FILES!
echo Successfully processed: !PROCESSED_FILES!
echo Failed: !FAILED_FILES!
echo.

if !FAILED_FILES! gtr 0 (
    echo Some files failed to process. Check the output above for details.
)

echo Output directory: !OUTPUT_DIR!
echo.
pause
