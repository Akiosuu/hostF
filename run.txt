@echo off
setlocal enabledelayedexpansion

:: MP4 Video Compression Script
:: Compresses all MP4 files in a directory while maintaining folder structure

echo ================================
echo MP4 Video Compression Script
echo ================================
echo.

:: Check if ffmpeg is available
ffmpeg -version >nul 2>&1
if errorlevel 1 (
    echo ERROR: ffmpeg is not found in PATH
    echo Please install ffmpeg and add it to your system PATH
    echo Download from: https://ffmpeg.org/download.html
    pause
    exit /b 1
)

:: Get source directory
if "%~1"=="" (
    set /p "SOURCE_DIR=Enter source directory path: "
) else (
    set "SOURCE_DIR=%~1"
)

:: Validate source directory
if not exist "!SOURCE_DIR!" (
    echo ERROR: Source directory does not exist: !SOURCE_DIR!
    pause
    exit /b 1
)

:: Get output directory
set /p "OUTPUT_DIR=Enter output directory path: "

:: Create output directory if it doesn't exist
if not exist "!OUTPUT_DIR!" (
    mkdir "!OUTPUT_DIR!"
)

:: Quality settings (you can modify these)
set "CRF=23"
set "PRESET=medium"
set "CODEC=libx264"

echo.
echo Settings:
echo - Source: !SOURCE_DIR!
echo - Output: !OUTPUT_DIR!
echo - Quality (CRF): !CRF! (lower = better quality, larger file)
echo - Preset: !PRESET!
echo - Codec: !CODEC!
echo.

:: Confirm before proceeding
set /p "CONFIRM=Continue? (y/n): "
if /i not "!CONFIRM!"=="y" (
    echo Operation cancelled.
    pause
    exit /b 0
)

echo.
echo Starting compression...
echo.

:: Initialize counters
set "TOTAL_FILES=0"
set "PROCESSED_FILES=0"
set "FAILED_FILES=0"

:: Count total MP4 files first
for /r "!SOURCE_DIR!" %%f in (*.mp4) do (
    set /a TOTAL_FILES+=1
)

echo Found !TOTAL_FILES! MP4 files to process.
echo.

:: Process all MP4 files
for /r "!SOURCE_DIR!" %%f in (*.mp4) do (
    set "INPUT_FILE=%%f"
    
    :: Calculate relative path
    set "REL_PATH=!INPUT_FILE:*%SOURCE_DIR%=!"
    if "!REL_PATH:~0,1!"=="\" set "REL_PATH=!REL_PATH:~1!"
    
    :: Create output file path
    set "OUTPUT_FILE=!OUTPUT_DIR!\!REL_PATH!"
    
    :: Create output directory structure
    for %%d in ("!OUTPUT_FILE!") do (
        if not exist "%%~dpd" mkdir "%%~dpd"
    )
    
    :: Skip if output file already exists
    if exist "!OUTPUT_FILE!" (
        echo SKIPPING: !REL_PATH! (already exists)
        set /a PROCESSED_FILES+=1
    ) else (
        echo Processing: !REL_PATH!
        
        :: Compress video with high quality settings
        ffmpeg -i "!INPUT_FILE!" ^
               -c:v !CODEC! ^
               -crf !CRF! ^
               -preset !PRESET! ^
               -c:a aac ^
               -b:a 128k ^
               -movflags +faststart ^
               -y "!OUTPUT_FILE!" >nul 2>&1
        
        if !errorlevel! equ 0 (
            echo SUCCESS: !REL_PATH!
            set /a PROCESSED_FILES+=1
            
            :: Show file size comparison
            for %%a in ("!INPUT_FILE!") do set "INPUT_SIZE=%%~za"
            for %%b in ("!OUTPUT_FILE!") do set "OUTPUT_SIZE=%%~zb"
            
            set /a "COMPRESSION_RATIO=(!INPUT_SIZE! - !OUTPUT_SIZE!) * 100 / !INPUT_SIZE!"
            echo   Original: !INPUT_SIZE! bytes
            echo   Compressed: !OUTPUT_SIZE! bytes
            echo   Saved: !COMPRESSION_RATIO!%%
        ) else (
            echo FAILED: !REL_PATH!
            set /a FAILED_FILES+=1
        )
    )
    echo.
)

:: Final summary
echo ================================
echo Compression Complete!
echo ================================
echo Total files found: !TOTAL_FILES!
echo Successfully processed: !PROCESSED_FILES!
echo Failed: !FAILED_FILES!
echo.

if !FAILED_FILES! gtr 0 (
    echo Some files failed to process. Check the output above for details.
)

echo Output directory: !OUTPUT_DIR!
echo.
pause
